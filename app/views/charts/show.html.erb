<%= render 'select_options' %>
<div class="chart_meta">
  <div class="returns">
    <% @stock.performance.returns.each do |key, return_percentage| %>
        <%= "#{key}: " %> <%= raw display_returns(return_percentage) %>
    <% end %>
  </div>
  <div class="title"><%=@stock.symbol%></div>
  <div class="legend mov_avg_10d">10 Days Avg</div>
  <div class="legend mov_avg_50d">50 Days Avg</div>
  <div class="legend mov_avg_200d">200 Days Avg</div>
  <div class="legend volume">Trading Volume</div>
  <div class="legend eps">EPS</div>
</div>

<div id="chart"></div>
<script type="text/javascript">
    <%
    quaterly_eps = @all_results.inject({}) do |hash, result|
    hash[result.quarter_end] = result.eps
    hash
    end
    data = []
    last_eps = 1
    @quotes.each do |quote|
        eps = quaterly_eps[quote.date.end_of_quarter] || last_eps
        data << {date: quote.date, open: quote.open.to_f, high: quote.high.to_f, low: quote.low.to_f, close: quote.close.to_f,
        mov_avg_10d: quote.mov_avg_10d.to_f, mov_avg_50d: quote.mov_avg_50d.to_f, mov_avg_200d: quote.mov_avg_200d.to_f,
        traded_quantity: quote.traded_quantity.to_f, pe: (quote.close/(eps*4)), eps: eps*4}
        last_eps = eps
    end

    result_data = @results.collect do |result|
        {start_date: result.quarter_start, end_date: result.quarter_end, eps: result.eps}
    end
    %>
    new OHLC({data: <%=raw data.to_json %>, chartId: "#chart", eps_data: <%=raw result_data.to_json %>});
</script>

